# ============================================================
# ShellIA - Docker Compose (Linux / Ubuntu)
# ============================================================
# Usage :
#   Start   : docker compose up -d
#   Logs    : docker compose logs -f
#   Stop    : docker compose down
#   Rebuild : docker compose up -d --build
#   Pull    : docker compose pull
# ============================================================

services:

  shellia:
    image: blackbeardteam/shellia:latest
    container_name: shellia
    restart: unless-stopped

    ports:
      - "${SHELLIA_PORT:-8000}:8000"

    environment:
      - SHELLIA_ENV=${SHELLIA_ENV:-local}
      - TZ=${TZ:-Europe/Paris}
      # ⚠️  Generate with: openssl rand -hex 32
      - SECRET_KEY=${SECRET_KEY:-}

      # ── Google OAuth ─────────────────────────────────────
      # Get your credentials at:
      #   https://console.cloud.google.com → APIs & Services → Credentials
      #   → Create credentials → OAuth 2.0 Client ID → Web application
      # Authorized JavaScript origins : http://YOUR_IP:8000
      # Authorized redirect URIs      : http://YOUR_IP:8000/auth/google/callback
      - GOOGLE_CLIENT_ID=
      - GOOGLE_CLIENT_SECRET=

    volumes:
      # User database (SQLite)
      - shellia_data:/app/data
      # User profiles, environments and APIs
      - shellia_users:/app/users
      # Global environments
      - shellia_environments:/app/environments

    networks:
      - shellia_net

    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
        reservations:
          memory: 128M

  # ============================================================
  # Watchtower — Auto-update ShellIA when a new image is pushed
  # ============================================================
  # Enable with:  docker compose --profile watchtower up -d
  # Disable with: docker compose --profile watchtower down
  # ============================================================
  watchtower:
    image: containrrr/watchtower:latest
    container_name: shellia_watchtower
    restart: unless-stopped
    profiles: ["watchtower"]

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

    environment:
      # Pull and restart shellia only (not all containers)
      - WATCHTOWER_SCOPE=shellia
      # Clean up old images after update
      - WATCHTOWER_CLEANUP=true
      # Check for new image every hour (3600 seconds)
      - WATCHTOWER_POLL_INTERVAL=3600
      # Send a notification in the logs when an update is applied
      - WATCHTOWER_INCLUDE_RESTARTING=true

    # Watch only the shellia container
    command: shellia

    networks:
      - shellia_net

volumes:
  shellia_data:
    name: shellia_data
  shellia_users:
    name: shellia_users
  shellia_environments:
    name: shellia_environments

networks:
  shellia_net:
    name: shellia_net
    driver: bridge
